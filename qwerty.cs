
// Skeleton generated by Hyland Unity Editor on 3/17/2021 12:18:40 AM
namespace testam1
{
    using System;
    using System.Text;
    using Hyland.Unity;
    using Hyland.Unity.CodeAnalysis;
    using Hyland.Unity.Workflow;
	
    /// <summary>
    /// testam
    /// </summary>
    public class testam1 : Hyland.Unity.IWorkflowScript
    {
		Hyland.Unity.Application _app= null;
		string priKey = string.Empty;
		string secKey = string.Empty;
		string priVal = string.Empty;
		string secVal = string.Empty;
		
		
		
        #region IWorkflowScript
        /// <summary>
        /// Implementation of <see cref="IWorkflowScript.OnWorkflowScriptExecute" />.
        /// <seealso cref="IWorkflowScript" />
        /// </summary>
        /// <param name="app"></param>
        /// <param name="args"></param>
        public void OnWorkflowScriptExecute(Hyland.Unity.Application app, Hyland.Unity.WorkflowEventArgs args)
        {
         	args.SessionPropertyBag.TryGetValue("propPriKey", out priKey);
			args.SessionPropertyBag.TryGetValue("propSecKey", out secKey);
			Document doc = args.Document;
			DocumentType docType = doc.DocumentType;
			SetKeywordValues(doc);
			DocumentQuery docQuery = app.Core.CreateDocumentQuery();
			docQuery.AddDocumentType(docType);
			
			KeywordType keyType = app.Core.KeywordTypes.Find(priKey);
			Keyword priKeyword = keyType.CreateKeyword(priVal);
			
			docQuery.AddKeyword(priKeyword);
			
			DocumentList docList = docQuery.Execute(10000);
			
			Keyword secKeyword = keyType.CreateKeyword(secVal);
			foreach(Document newDoc in docList)
			{
				foreach(KeywordRecord keywordRecord in newDoc.KeywordRecords)
		        {
					foreach(Keyword keyword in keywordRecord.Keywords)
				    {
						if(keyword.KeywordType.Name==priKey)
				        {
							string priGetValToCompare = keyword.IsBlank?string.Empty:keyword.Value.ToString();
							if(priGetValToCompare.Trim()==priVal.Trim())
							{
								using(DocumentLock documentLock = newDoc.LockDocument())
								{
									if(documentLock.Status == DocumentLockStatus.LockObtained)
									{
										KeywordModifier keymod = newDoc.CreateKeywordModifier();
										keymod.UpdateKeyword(priKeyword, secKeyword);
										keymod.ApplyChanges();
										break;
									}
								}
							}
						}
					}
				}
			}
        }

		private void SetKeywordValues(Hyland.Unity.Document document)
		{
			try
		   	{
		   		foreach(KeywordRecord keywordRecord in document.KeywordRecords)
		        {
		        	foreach(Keyword keyword in keywordRecord.Keywords)
		            {
						if(keyword.KeywordType.Name == priKey)
							priVal = keyword.IsBlank?string.Empty:keyword.Value.ToString();
						if(keyword.KeywordType.Name == secKey)
							secVal = keyword.IsBlank?string.Empty:keyword.Value.ToString();
						
					}
				}
		   }
		   catch(Exception ex)
		   {
		   		_app.Diagnostics.Write(ex);
		   }
		}
        #endregion
    }
}
